<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ExamArena Admin</title>
  <!-- Firebase SDKs - NO TRAILING SPACES -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif }
    body {
      background: #f8fafc;
      color: #1e293b;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #e2e8f0;
      padding: 20px;
      overflow-y: auto;
    }
    .main-content {
      flex: 1;
      padding: 24px;
    }
    header {
      background: #1e40af;
      color: white;
      padding: 16px;
      text-align: center;
      margin: -24px -24px 24px -24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 1.5rem;
    }
    .category-item, .test-item {
      padding: 14px 16px;
      margin-bottom: 12px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .category-name, .test-title {
      font-weight: 600;
      color: #1e293b;
    }
    .category-count {
      color: #64748b;
      font-size: 0.9rem;
    }
    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .form-group input, .form-group button {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 16px;
    }
    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }
    .form-group button {
      background: #3b82f6;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .form-group button:hover {
      background: #2563eb;
    }
    .status {
      padding: 12px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: 500;
    }
    .success { background: #dcfce7; color: #166534; }
    .error { background: #fee2e2; color: #b91c1c; }
    .note {
      background: #dbeafe;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 14px;
      color: #1e40af;
    }
    .empty-state {
      text-align: center;
      padding: 40px 0;
      color: #94a3b8;
    }
    .mode-indicator {
      display: inline-block;
      padding: 4px 10px;
      background: #dbeafe;
      color: #1d4ed8;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2 style="margin-bottom:20px; color:#1e40af; text-align:center;">
      <span id="sidebarTitle">‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä‡§ú‡§º</span>
      <span id="backButton" style="float:right; cursor:pointer; color:#3b82f6; display:none;" onclick="goBack()">‚¨ÖÔ∏è</span>
    </h2>
    <div id="listContainer">
      <div class="empty-state">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
    </div>
  </div>

  <div class="main-content">
    <header>
      <div>
        <h1>ExamArena ‚Ä¢ ‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡•à‡§®‡§≤</h1>
      </div>
      <div id="modeInfo" class="mode-indicator">‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡•Ç</div>
    </header>

    <div class="form-group">
      <label for="category">‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä</label>
      <input type="text" id="category" placeholder="‡§ú‡•à‡§∏‡•á: Lucent GK" />

      <label for="categoryImage">‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§á‡§Æ‡•á‡§ú URL (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
      <input type="url" id="categoryImage" placeholder="https://example.com/image.jpg" />

      <label for="title">‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
      <input type="text" id="title" placeholder="‡§ú‡•à‡§∏‡•á: Lucent Chapter 1" />

      <label for="csv">CSV ‡§Ø‡§æ TXT ‡§´‡§º‡§æ‡§á‡§≤</label>
      <input type="file" id="csv" accept=".csv,.txt" />

      <button onclick="createTest()">‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å</button>

      <div id="status"></div>

      <div class="note">
        <strong>CSV ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü:</strong><br>
        ‡§™‡§π‡§≤‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø: <code>question,optionA,optionB,optionC,optionD,correct</code><br>
        ‡§â‡§¶‡§æ‡§π‡§∞‡§£: <code>"2+2?", "3", "4", "5", "6", "B"</code><br><br>
        <strong>TXT ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü:</strong><br>
        6 ‡§≤‡§æ‡§á‡§®‡•á‡§Ç ‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§®:<br>
        1. ‡§™‡•ç‡§∞‡§∂‡•ç‡§®<br>
        2‚Äì5. ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ A, B, C, D<br>
        6. ‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞ (A/B/C/D)
      </div>
    </div>
  </div>

  <script>
    // ‚ö†Ô∏è SECURITY NOTE: Remove or secure delete functionality in production!
    const ADMIN_PASSWORD = "12345";

    let currentView = 'categories';
    let currentCategory = null;

    // üî• Firebase Config (Your Project)
    firebase.initializeApp({
      apiKey: "AIzaSyAkLZnHOp2-jXMiNzhIwZE-Fgs6OEb89rw",
      authDomain: "quiz-app-64a74.firebaseapp.com",
      projectId: "quiz-app-64a74",
      storageBucket: "quiz-app-64a74.firebasestorage.app",
      messagingSenderId: "665162938804",
      appId: "1:665162938804:web:2066494d51f97ec2561ae1"
    });
    const db = firebase.firestore();

    // ‚úÖ CSV Parser
    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) return [];
      const questions = [];
      for (let i = 1; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        const values = [];
        let inQuotes = false;
        let current = '';
        for (const char of line) {
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current);
        if (values.length >= 6) {
          const q = values[0].replace(/^"|"$/g, '').trim();
          const options = [
            values[1].replace(/^"|"$/g, '').trim(),
            values[2].replace(/^"|"$/g, '').trim(),
            values[3].replace(/^"|"$/g, '').trim(),
            values[4].replace(/^"|"$/g, '').trim()
          ];
          const correct = values[5].replace(/^"|"$/g, '').trim().toUpperCase();
          if (q && options.every(opt => opt) && ['A','B','C','D'].includes(correct)) {
            questions.push({ q, options, correct });
          }
        }
      }
      return questions;
    }

    // ‚úÖ TXT Parser (6 lines per question)
    function parseTXT(txtText) {
      const lines = txtText.split('\n').map(l => l.trim()).filter(l => l !== '');
      const questions = [];
      for (let i = 0; i < lines.length; i += 6) {
        if (i + 5 >= lines.length) break;
        const q = lines[i];
        const options = [lines[i+1], lines[i+2], lines[i+3], lines[i+4]];
        const correct = lines[i+5].toUpperCase();
        if (q && options.every(opt => opt) && ['A','B','C','D'].includes(correct)) {
          questions.push({ q, options, correct });
        }
      }
      return questions;
    }

    // üöÄ Create Test (supports .csv and .txt)
    async function createTest() {
      const category = document.getElementById('category').value.trim();
      const categoryImage = document.getElementById('categoryImage').value.trim();
      const title = document.getElementById('title').value.trim();
      const file = document.getElementById('csv').files[0];
      const statusDiv = document.getElementById('status');

      if (!category || !title || !file) {
        statusDiv.className = 'status error';
        statusDiv.innerText = "‚ö†Ô∏è ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§";
        return;
      }

      try {
        const text = await file.text();
        let questions = [];

        if (file.name.endsWith('.csv')) {
          questions = parseCSV(text);
        } else if (file.name.endsWith('.txt')) {
          questions = parseTXT(text);
        } else {
          throw new Error("‡§ï‡•á‡§µ‡§≤ .csv ‡§Ø‡§æ .txt ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§π‡•à‡§Ç‡•§");
        }

        if (questions.length === 0) throw new Error("‡§ï‡•ã‡§à ‡§µ‡•à‡§ß ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");

        const testData = {
          category,
          title,
          questions,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (categoryImage) testData.categoryImage = categoryImage;

        await db.collection('tests').add(testData);
        statusDiv.className = 'status success';
        statusDiv.innerText = `‚úÖ ‡§ü‡•á‡§∏‡•ç‡§ü "${title}" (${category}) ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!`;

        // Reset form
        document.getElementById('category').value = '';
        document.getElementById('categoryImage').value = '';
        document.getElementById('title').value = '';
        document.getElementById('csv').value = '';

        // Refresh sidebar
        if (currentView === 'categories') {
          loadCategories();
        } else if (currentView === 'tests' && category === currentCategory) {
          loadTestsForCategory(currentCategory);
        }
      } catch (err) {
        statusDiv.className = 'status error';
        statusDiv.innerText = "‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + (err.message || "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
      }
    }

    // ===== Sidebar Navigation =====
    async function loadCategories() {
      currentView = 'categories';
      currentCategory = null;
      document.getElementById('sidebarTitle').textContent = '‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä‡§ú‡§º';
      document.getElementById('backButton').style.display = 'none';
      document.getElementById('modeInfo').textContent = '‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡•Ç';

      const listDiv = document.getElementById('listContainer');
      try {
        const snapshot = await db.collection('tests').get();
        if (snapshot.empty) {
          listDiv.innerHTML = '<div class="empty-state">‡§ï‡•ã‡§à ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</div>';
          return;
        }

        const categoryMap = {};
        snapshot.docs.forEach(doc => {
          const data = doc.data();
          if (categoryMap[data.category]) {
            categoryMap[data.category].count++;
          } else {
            categoryMap[data.category] = { count: 1 };
          }
        });

        let html = '';
        Object.keys(categoryMap).sort().forEach(cat => {
          const { count } = categoryMap[cat];
          html += `
            <div class="category-item" onclick="showTestsForCategory('${cat}')">
              <div>
                <div class="category-name">${cat}</div>
                <div class="category-count">${count} ‡§ü‡•á‡§∏‡•ç‡§ü${count > 1 ? '‡•ç‡§∏' : ''}</div>
              </div>
              <button class="delete-btn" onclick="deleteCategory(event, '${cat}')">√ó</button>
            </div>
          `;
        });
        listDiv.innerHTML = html;
      } catch (err) {
        listDiv.innerHTML = `<div class="empty-state">‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ</div>`;
      }
    }

    async function showTestsForCategory(category) {
      currentView = 'tests';
      currentCategory = category;
      document.getElementById('sidebarTitle').textContent = category;
      document.getElementById('backButton').style.display = 'inline';
      document.getElementById('modeInfo').textContent = '‡§ü‡•á‡§∏‡•ç‡§ü ‡§µ‡•ç‡§Ø‡•Ç';
      loadTestsForCategory(category);
    }

    async function loadTestsForCategory(category) {
      const listDiv = document.getElementById('listContainer');
      try {
        const snapshot = await db.collection('tests').where('category', '==', category).get();
        if (snapshot.empty) {
          listDiv.innerHTML = '<div class="empty-state">‡§á‡§∏ ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ü‡•á‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</div>';
          return;
        }

        let html = '';
        snapshot.docs.forEach(doc => {
          const data = doc.data();
          html += `
            <div class="test-item">
              <div class="test-title">${data.title}</div>
              <button class="delete-btn" onclick="deleteTest('${doc.id}')">√ó</button>
            </div>
          `;
        });
        listDiv.innerHTML = html;
      } catch (err) {
        listDiv.innerHTML = `<div class="empty-state">‡§ü‡•á‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•á</div>`;
      }
    }

    function goBack() {
      loadCategories();
    }

    // ===== Delete Functions (Use with Caution!) =====
    async function deleteCategory(e, category) {
      e.stopPropagation();
      const password = prompt("‡§á‡§∏ ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:");
      if (password !== ADMIN_PASSWORD) {
        alert("‚ùå ‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!");
        return;
      }

      if (!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à "${category}" ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§î‡§∞ ‡§á‡§∏‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§ü‡•á‡§∏‡•ç‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
        return;
      }

      try {
        const snapshot = await db.collection('tests').where('category', '==', category).get();
        const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(deletePromises);
        alert(`‚úÖ "${category}" ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à!`);
        loadCategories();
      } catch (err) {
        alert("‚ùå ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + err.message);
      }
    }

    async function deleteTest(testId) {
      if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
      try {
        await db.collection('tests').doc(testId).delete();
        alert("‡§ü‡•á‡§∏‡•ç‡§ü ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!");
        if (currentView === 'tests') {
          loadTestsForCategory(currentCategory);
        } else {
          loadCategories();
        }
      } catch (err) {
        alert("‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + err.message);
      }
    }

    // Start
    loadCategories();
  </script>
</body>
</html>